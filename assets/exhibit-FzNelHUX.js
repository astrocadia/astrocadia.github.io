var P=Object.defineProperty;var H=(r,e,t)=>e in r?P(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var L=(r,e,t)=>H(r,typeof e!="symbol"?e+"":e,t);import{f as $,b as v,g as l}from"./api-CCwLZuzR.js";import{d as y}from"./index-DT9bQTP5.js";import{a as T,i as O,b as U,M as N}from"./exhibitManifest-ppDTbDFq.js";import{i as R}from"./lang-BqISUGWn.js";import"./store-DcPsTEhE.js";const g=(r,e)=>{if(Array.isArray(r)){const t=r.length;for(let a=0;a<t;a++){const c=g(r[a],e);if(c)return c}}else{if(r.manifestId===e)return r;if(T(r)&&e.startsWith(r.manifestId)){const t=r.settinglistitems.length;for(let a=0;a<t;a++){const c=r.settinglistitems[a],d=g(c.items,e);if(d)return d}return}if(O(r)&&e.startsWith(r.manifestId))return g(r.settings,e)||g(r.settingLists,e)||g(r.settingGroups,e)}},u=(r,e)=>R(r)&&R(e)?r===e:r===null||e===null?!1:Number(r)===Number(e),_=r=>{var t;const e=(t=document.cookie.match(`(^|;)\\s*${r}\\s*=\\s*([^;]+)`))==null?void 0:t.pop();return e?decodeURIComponent(e):void 0},K=r=>{document.cookie=`${encodeURIComponent(r)}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`};y.SOCKET_EVENT_TYPE.EXHIBIT_HEALTH_UPDATED,y.SOCKET_EVENT_TYPE.COMPONENT_CONNECTED,y.SOCKET_EVENT_TYPE.COMPONENT_DISCONNECTED,y.SOCKET_EVENT_TYPE.COMPONENT_PROPERTY_RECEIVED;const w=(r,e)=>typeof r=="object"&&r!==null&&"action"in r&&r.action===e,h=class h{constructor(){h.instance||(h.instance=this,h.exhibitSubscriptions=new Set,h.hardwareSubscriptions=new Set,h.listeners=new Map,h.socket=new WebSocket($()))}static async getInstance(){return new Promise((e,t)=>{if(h.instance)e(h.instance);else{const a=_("dltoken");R(a)?t(new Error("dltoken unavailable")):(h.instance=new h,h.socket.onopen=()=>{h.socket.addEventListener("message",c=>{JSON.parse(c.data).action==="HANDSHAKE_SUCCESSFUL"&&(h.connected=!0,e(h.instance))},{once:!0}),h.socket.send(JSON.stringify({action:"HANDSHAKE",data:{jwt:a}}))},h.socket.onclose=()=>{h.connected=!1})}})}static close(){h.instance&&(h.socket.close(),h.instance=null)}subscribeToExhibits(e){Array.isArray(e)?e.forEach(t=>{h.exhibitSubscriptions.add(t)}):h.exhibitSubscriptions.add(e),h.socket.send(JSON.stringify({action:"SUBSCRIBE_MULTIPLE_EXHIBITS",data:{exhibits:Array.from(h.exhibitSubscriptions)}}))}subscribeToHardware(e){Array.isArray(e)?e.forEach(t=>{h.hardwareSubscriptions.add(t)}):h.hardwareSubscriptions.add(e),h.socket.send(JSON.stringify({action:"SUBSCRIBE_MULTIPLE_HARDWARE",data:{hardware:Array.from(h.hardwareSubscriptions)}}))}unsubscribeFromExhibits(e){if(!h.connected)return;const t=Array.isArray(e)?e:[e];t.forEach(a=>{h.exhibitSubscriptions.delete(a)}),h.socket.send(JSON.stringify({action:"UNSUBSCRIBE_MULTIPLE_EXHIBITS",data:{exhibits:t}}))}unsubscribeFromHardware(e){if(!h.connected)return;const t=Array.isArray(e)?e:[e];t.forEach(a=>{h.hardwareSubscriptions.delete(a)}),h.socket.send(JSON.stringify({action:"UNSUBSCRIBE_MULTIPLE_HARDWARE",data:{hardware:t}}))}addMessageEventListener(e,t){const a=c=>{const d=JSON.parse(c.data);w(d,e)&&t(d.data)};h.listeners.set(t,a),h.socket.addEventListener("message",a)}removeMessageEventListener(e){const t=h.listeners.get(e);t&&h.socket.removeEventListener("message",t),h.listeners.delete(t)}};L(h,"instance"),L(h,"socket"),L(h,"exhibitSubscriptions"),L(h,"hardwareSubscriptions"),L(h,"listeners"),L(h,"connected",!1);let b=h;const M=v.injectEndpoints({endpoints:r=>({getExhibitManifest:r.query({query:({exhibitId:e})=>`${l("exhibit")}/exhibit-management/exhibit/${e}/manifest`,async onCacheEntryAdded({exhibitId:e},{updateCachedData:t,cacheDataLoaded:a,cacheEntryRemoved:c,dispatch:d}){const f=o=>{u(o.exhibitId,e)&&t(m=>{m.online=!0})},p=o=>{parseInt(o.exhibitId,10)===e&&t(m=>{m.online=!1})},x=o=>{o.id===e&&t(m=>{m.opMode=o.mode?"On":"Off"})},s=o=>{t(m=>{(g(m.settingLists,o.id)||g(m.settingGroups,o.id))&&d(v.util.invalidateTags(["ExhibitManifest"]))})},E=o=>{o.id===e&&t(m=>{const I=g(m.settings,o.manifestId)||g(m.settingLists,o.manifestId)||g(m.settingGroups,o.manifestId);I&&!O(I)&&!T(I)&&(I.value=o.settingValue)})},n=o=>{t(m=>{const I=m.statuses.find(S=>S.id===o.id);I&&I.type===U.STRING&&o.type===U.STRING&&(I.value=o.value,I.updatedAt=o.updatedAt)})};let i;try{await a,i=await b.getInstance(),i.addMessageEventListener("EXHIBIT_ONLINE",f),i.addMessageEventListener("EXHIBIT_OFFLINE",p),i.addMessageEventListener("OP_MODE_RECEIVED",x),i.addMessageEventListener("SETTING_LIST_RECEIVED",s),i.addMessageEventListener("SETTING_RECEIVED",E),i.addMessageEventListener("STATUS_RECEIVED",n),i.subscribeToExhibits(e)}catch{}await c,i==null||i.removeMessageEventListener(f),i==null||i.removeMessageEventListener(p),i==null||i.removeMessageEventListener(x),i==null||i.removeMessageEventListener(s),i==null||i.removeMessageEventListener(E),i==null||i.removeMessageEventListener(n)},transformResponse:e=>e.manifest,providesTags:e=>e?[{type:"ExhibitManifest",id:e.id},"ExhibitManifest"]:["ExhibitManifest"]}),getExhibitManifestWithoutStatusSubscription:r.query({query:({exhibitId:e})=>`${l("exhibit")}/exhibit-management/exhibit/${e}/manifest`,async onCacheEntryAdded({exhibitId:e},{updateCachedData:t,cacheDataLoaded:a,cacheEntryRemoved:c,dispatch:d}){const f=i=>{u(i.exhibitId,e)&&t(o=>{o.online=!0})},p=i=>{parseInt(i.exhibitId,10)===e&&t(o=>{o.online=!1})},x=i=>{i.id===e&&t(o=>{o.opMode=i.mode?"On":"Off"})},s=i=>{t(o=>{(g(o.settingLists,i.id)||g(o.settingGroups,i.id))&&d(v.util.invalidateTags(["ExhibitManifest"]))})},E=i=>{i.id===e&&t(o=>{const m=g(o.settings,i.manifestId)||g(o.settingLists,i.manifestId)||g(o.settingGroups,i.manifestId);m&&!O(m)&&!T(m)&&(m.value=i.settingValue)})};let n;try{await a,n=await b.getInstance(),n.addMessageEventListener("EXHIBIT_ONLINE",f),n.addMessageEventListener("EXHIBIT_OFFLINE",p),n.addMessageEventListener("OP_MODE_RECEIVED",x),n.addMessageEventListener("SETTING_LIST_RECEIVED",s),n.addMessageEventListener("SETTING_RECEIVED",E),n.subscribeToExhibits(e)}catch{}await c,n==null||n.removeMessageEventListener(f),n==null||n.removeMessageEventListener(p),n==null||n.removeMessageEventListener(x),n==null||n.removeMessageEventListener(s),n==null||n.removeMessageEventListener(E)},transformResponse:e=>e.manifest,providesTags:e=>e?[{type:"ExhibitManifest",id:e.id},"ExhibitManifest"]:["ExhibitManifest"]})})});v.injectEndpoints({endpoints:r=>({triggerExhibitControl:r.mutation({query:({exhibitId:e,controlId:t,itemId:a})=>({url:`${l("exhibit")}/exhibit-management/exhibit/${e}/control/${t}`,method:"POST",params:{itemId:a}})})})});const B=v.injectEndpoints({endpoints:r=>({getExhibitUsers:r.query({query:({exhibitId:e})=>({url:`${l("exhibit")}/exhibit-management/permission/by-exhibit-id/${e}`}),providesTags:["ExhibitUsers"],transformResponse:e=>e.exhibitUsers}),inviteNewExhibitUser:r.mutation({query:e=>({url:`${l("exhibit")}/exhibit-management/permission`,method:"POST",body:{exhibitCreated:!0,inviteVersion:"v2",...e}}),invalidatesTags:["ExhibitUsers"]}),updateExhibitUserPermission:r.mutation({query:({id:e,role:t})=>({url:`${l("exhibit")}/exhibit-management/permission/${e}`,method:"PUT",body:{role:t}}),invalidatesTags:["ExhibitUsers"]}),deleteExhibitUserPermission:r.mutation({query:({exhibitUserId:e})=>({url:`${l("exhibit")}/exhibit-management/permission/${e}`,method:"DELETE"}),invalidatesTags:["ExhibitUsers"]})})}),{useGetExhibitUsersQuery:Y,useInviteNewExhibitUserMutation:z,useUpdateExhibitUserPermissionMutation:Z,useDeleteExhibitUserPermissionMutation:k}=B;v.injectEndpoints({endpoints:r=>({getScheduledEvents:r.query({query:({exhibitId:e})=>({url:`${l("exhibit")}/exhibit-management/scheduling/${e}`}),transformResponse:e=>e.schedules,providesTags:["ExhibitScheduledEvents"]}),createEvent:r.mutation({query:({exhibitId:e,...t})=>({url:`${l("exhibit")}/exhibit-management/scheduling/${e}`,method:"POST",body:t}),invalidatesTags:["ExhibitScheduledEvents"]}),updateEvent:r.mutation({query:({eventId:e,...t})=>({url:`${l("exhibit")}/exhibit-management/scheduling/${e}`,method:"PUT",body:{...t,eventId:e}}),invalidatesTags:["ExhibitScheduledEvents"]}),deleteEvent:r.mutation({query:({eventId:e,recurringId:t,changeAll:a})=>({url:`${l("exhibit")}/exhibit-management/scheduling/${e}`,method:"DELETE",params:{recurringId:t,changeAll:a}}),invalidatesTags:["ExhibitScheduledEvents"]})})});const V=v.injectEndpoints({endpoints:r=>({createExhibitManifestSettingsListItem:r.mutation({query:({exhibitId:e,settingListId:t,itemName:a})=>({url:`${l("exhibit")}/exhibit-management/exhibit/${e}/settinglist/${t}`,method:"POST",body:{listName:a}}),async onQueryStarted(e,{dispatch:t,queryFulfilled:a}){try{const{data:{settingsList:c}}=await a,{settinglistitems:d,...f}=c,p=new Map;d.forEach(s=>{const E=s.manifestId.split(N).at(-2),n=E==null?void 0:E.replace(/"/g,"");if(n){const i=p.get(n);i?i.items.push(s):p.set(n,{listName:n,items:[s]})}});const x={type:"SettingsList",...f,settinglistitems:Array.from(p.values())};t(M.util.updateQueryData("getExhibitManifest",{exhibitId:e.exhibitId},s=>{const{manifestId:E}=x,n=E.split(N);if(n.length===1){const i=s.settingLists.findIndex(o=>o.id===x.id);i>=0&&(s.settingLists[i]=x)}else{n.pop();let i=n.join(N);const o=[...s.settingLists,...s.settingGroups];let m=g(o,i);if(m||(n.pop(),i=n.join(N),m=g(o,i)),O(m)){const I=m.settingLists.findIndex(S=>S.id===x.id);I>=0&&(m.settingLists[I]=x)}else if(T(m))for(let I=0,S=m.settinglistitems.length;I<S;I++){const C=m.settinglistitems[I],A=C.items.findIndex(D=>D.id===x.id);if(A>=0){C.items[A]=x;break}}}}))}catch{}}}),deleteExhibitManifestSettingsListItem:r.mutation({query:({exhibitId:e,settingListId:t,itemName:a})=>({url:`${l("exhibit")}/exhibit-management/exhibit/${e}/settinglist/${t}`,method:"DELETE",params:{listName:a}}),async onQueryStarted(e,{dispatch:t,queryFulfilled:a}){try{await a,t(M.util.updateQueryData("getExhibitManifest",{exhibitId:e.exhibitId},c=>{var f,p;const d=g([...c.settingLists,...c.settingGroups],e.manifestId);if(T(d)){const x=d.settinglistitems.findIndex(E=>E.listName===e.itemName);x>=0&&d.settinglistitems.splice(x,1);const s=((f=d.order)==null?void 0:f.indexOf(e.itemName))||-1;s>=0&&((p=d.order)==null||p.splice(s,1))}}))}catch{}}}),updateExhibitManifestSettingsListItemOrder:r.mutation({query:({exhibitId:e,settingListId:t,order:a})=>({url:`${l("exhibit")}/exhibit-management/exhibit/${e}/settinglist/${t}/order`,method:"POST",body:{order:a}}),async onQueryStarted(e,{dispatch:t,queryFulfilled:a}){try{const{data:c}=await a;c.order&&t(M.util.updateQueryData("getExhibitManifest",{exhibitId:e.exhibitId},d=>{const f=g([...d.settingLists,...d.settingGroups],e.manifestId);T(f)&&(f.order=c.order)}))}catch{}}}),updateExhibitSettings:r.mutation({query:e=>({url:`${l("exhibit")}/exhibit-management/exhibit/settings`,method:"POST",body:e}),async onQueryStarted(e,{dispatch:t,queryFulfilled:a}){try{const{data:{settings:c}}=await a;t(M.util.updateQueryData("getExhibitManifest",{exhibitId:e.settings[0].ExhibitId},d=>{const f=[...d.settings,...d.settingLists,...d.settingGroups];c==null||c.forEach(p=>{const x=g(f,p.manifestId);x&&!T(x)&&!O(x)&&(x.value=p.value)})}))}catch{}}}),updateExhibitStrapiSetting:r.mutation({query:({exhibitId:e,manifestId:t,contentId:a})=>({url:`${l("exhibit")}/exhibit-management/exhibit/${e}/strapi-content/${encodeURIComponent(t)}`,method:"PUT",body:{contentId:a}}),invalidatesTags:e=>e?[{type:"ExhibitManifest",id:e.strapiContent.ExhibitId}]:[]}),updateExhibitOpMode:r.mutation({query:e=>({url:`${l("exhibit")}/exhibit-management/exhibit/${e.exhibitId}/opMode`,method:"POST",body:e}),async onQueryStarted(e,{dispatch:t,queryFulfilled:a}){try{const{data:c}=await a;y.isSuccessResponseBody(c)&&t(M.util.updateQueryData("getExhibitManifest",{exhibitId:e.exhibitId},d=>{d.opMode=e.opMode}))}catch{}}})})}),{useCreateExhibitManifestSettingsListItemMutation:W,useDeleteExhibitManifestSettingsListItemMutation:ee,useUpdateExhibitManifestSettingsListItemOrderMutation:te,useUpdateExhibitSettingsMutation:ie,useUpdateExhibitStrapiSettingMutation:se,useUpdateExhibitOpModeMutation:ne}=V,q=v.injectEndpoints({endpoints:r=>({getExhibit:r.query({query:({exhibitId:e})=>`${l("exhibit")}/exhibit-management/exhibit/${e}`,transformResponse:e=>e.exhibit,providesTags:e=>e?[{type:"Exhibit",id:e.id},"Exhibit"]:["Exhibit"],async onCacheEntryAdded({exhibitId:e},{updateCachedData:t,cacheDataLoaded:a,cacheEntryRemoved:c}){const d=E=>{u(E.exhibitId,e)&&t(n=>{n.online=!0})},f=E=>{parseInt(E.exhibitId,10)===e&&t(n=>{n.online=!1})},p=E=>{E.id===e&&t(n=>{n.opMode=E.mode?"On":"Off"})},x=E=>{E.exhibitId===e&&t(n=>{n.healthState=E.healthState,n.numberDisconnectedComponents=E.numberDisconnectedComponents,n.totalNumberComponents=E.totalNumberComponents})};let s;try{await a,s=await b.getInstance(),s.addMessageEventListener("EXHIBIT_ONLINE",d),s.addMessageEventListener("EXHIBIT_OFFLINE",f),s.addMessageEventListener("OP_MODE_RECEIVED",p),s.addMessageEventListener("EXHIBIT_HEALTH_UPDATED",x),s.subscribeToExhibits(e)}catch{}await c,s==null||s.removeMessageEventListener(d),s==null||s.removeMessageEventListener(f),s==null||s.removeMessageEventListener(p),s==null||s.removeMessageEventListener(x)}}),getAllExhibits:r.query({query:()=>`${l("exhibit")}/exhibit-management/exhibit`,transformResponse:e=>e.exhibits,providesTags:e=>e?[...e.map(({siteId:t,organizationId:a})=>({type:"Exhibit",siteId:t,organizationId:a})),"Exhibit"]:["Exhibit"],async onCacheEntryAdded(e,{updateCachedData:t,cacheDataLoaded:a,cacheEntryRemoved:c}){const d=E=>{t(n=>{const i=n.find(o=>u(o.id,E.exhibitId));i&&(i.online=!0)})},f=E=>{t(n=>{const i=n.find(o=>u(o.id,E.exhibitId));i&&(i.online=!1)})},p=E=>{t(n=>{const i=n.find(o=>o.id===E.id);i&&(i.opMode=E.mode?"On":"Off")})},x=E=>{t(n=>{const i=n.find(o=>o.id===E.exhibitId);i&&(i.healthState=E.healthState,i.numberDisconnectedComponents=E.numberDisconnectedComponents,i.totalNumberComponents=E.totalNumberComponents)})};let s;try{const{data:E}=await a;s=await b.getInstance(),s.addMessageEventListener("EXHIBIT_ONLINE",d),s.addMessageEventListener("EXHIBIT_OFFLINE",f),s.addMessageEventListener("OP_MODE_RECEIVED",p),s.addMessageEventListener("EXHIBIT_HEALTH_UPDATED",x),s.subscribeToExhibits(E.map(n=>n.id))}catch{}await c,s==null||s.removeMessageEventListener(d),s==null||s.removeMessageEventListener(f),s==null||s.removeMessageEventListener(p),s==null||s.removeMessageEventListener(x)}}),createExhibit:r.mutation({query:({name:e,projectId:t})=>({url:`${l("exhibit")}/exhibit-management/exhibit`,method:"POST",body:{name:e,siteId:t}}),transformResponse:e=>e.exhibit,invalidatesTags:e=>e?[{type:"Project",id:e.siteId},"Exhibit"]:[]}),createExhibitToken:r.mutation({query:({exhibitId:e,name:t})=>({url:`${l("auth")}/auth/exhibit`,method:"POST",body:{name:t,exhibitId:e}}),transformResponse:e=>e.token}),getExhibitTokens:r.query({query:({exhibitId:e})=>({url:`${l("auth")}/auth/exhibit/${e}`}),transformResponse:e=>e.tokens}),listExhibits:r.query({query:({projectId:e})=>({url:`${l("exhibit")}/exhibit-management/exhibit/by-site-ids`,params:{siteId:[e]}}),transformResponse:e=>e.exhibits,providesTags:e=>e?[...e.map(({id:t})=>({type:"Exhibit",id:t})),"Exhibit"]:["Exhibit"],async onCacheEntryAdded(e,{updateCachedData:t,cacheDataLoaded:a,cacheEntryRemoved:c}){const d=E=>{t(n=>{const i=n.find(o=>u(o.id,E.exhibitId));i&&(i.online=!0)})},f=E=>{t(n=>{const i=n.find(o=>u(o.id,E.exhibitId));i&&(i.online=!1)})},p=E=>{t(n=>{const i=n.find(o=>o.id===E.id);i&&(i.opMode=E.mode?"On":"Off")})},x=E=>{t(n=>{const i=n.find(o=>o.id===E.exhibitId);i&&(i.healthState=E.healthState,i.numberDisconnectedComponents=E.numberDisconnectedComponents,i.totalNumberComponents=E.totalNumberComponents)})};let s;try{const{data:E}=await a;s=await b.getInstance(),s.addMessageEventListener("EXHIBIT_ONLINE",d),s.addMessageEventListener("EXHIBIT_OFFLINE",f),s.addMessageEventListener("OP_MODE_RECEIVED",p),s.addMessageEventListener("EXHIBIT_HEALTH_UPDATED",x),s.subscribeToExhibits(E.map(n=>n.id))}catch{}await c,s==null||s.removeMessageEventListener(d),s==null||s.removeMessageEventListener(f),s==null||s.removeMessageEventListener(p),s==null||s.removeMessageEventListener(x)}})})}),{useGetExhibitQuery:re,useListExhibitsQuery:oe,useGetAllExhibitsQuery:Ee,useCreateExhibitTokenMutation:ae,useGetExhibitTokensQuery:he,useCreateExhibitMutation:de}=q;export{b as G,re as a,oe as b,Y as c,Z as d,u as e,g as f,k as g,z as h,K as r,ee as u};
